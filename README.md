# 34 指令MIPS微处理器设计
实现一个34指令cpu。

## 一、体系架构

### 1.1 指令集

![pic1](https://github.com/WongYuetYee/CPU34/blob/main/gen_instruction/%E5%9B%BE%E7%89%871.png)

本设计支持图1所示的34条指令，其中，该设计将根据[31:26]和[5:0]两部分识别指令，并进一步根据识别出的指令读取操作数、立即数等，完成相应的操作。图中，rs表示源操作数的寄存器地址，rd表示目的存储的寄存器地址，在缺乏rd时，rt用作目的存储的寄存器地址，否则，rt用作第二个操作数的寄存器地址。
Offset/ind/imm/sa皆为立即数。

## 二、研究路线图
### 2.1工具
- Xilinx vivado 2019.2（用于综合、仿真）
- Python(用作编译、产生随机测试指令与数据)

### 2.2 数据流
CPU模块从ProgramCache中提取程序，并将提取出的操作码输向ALU和PCU模块（ALU和PCU模块利用goahead和finish两个信号互相通讯，从而实现轮流工作的形式）。
ALU模块将率先启动，将操作码送往ALU_Ctr，并进入状态机的初始状态，根据操作码和状态码把操作数、地址等从Registers模块里提取出来，送往ALU_Cal进行相应的计算，产生相应的结果以及新的状态码。
完成指令操作后，ALU模块内进入结束等待状态，向PCU模块发送信号，PCU模块开始工作。
PCU模块启动后，根据输入的操作码和状态码判断是否进行程序跳转，更新指令寄存器，更新后向ALU发送信号，使ALU从等待状态进入初始状态。

## 三、电路框架
### 3.1模块
![pic2](https://github.com/WongYuetYee/CPU34/blob/main/gen_instruction/%E5%9B%BE%E7%89%872.png)

## 四、总结
### 1.框架设计
ALU部分采用控制和计算分离的结构，使用状态机控制数据流向，每个状态使用的电路单元不同，方便之后做流水线的改造扩展。
共用电路单元皆使用三态门控制，保证电路单元流入数据的纯粹性（避免多驱动造成冲突），在不使用时呈高阻态，节省电量。
ALU与PCU的沟通主要通过PSW(本程序中为Flag模块)达成，减少不必要的电路连接。

### 2.程序编写
使用`define宏定义和参数parameter减少代码重复性，提高可读性，且便于随时修改。

### 3.测试验证
使用python编写了gen_opnum.py和to_instruction.py两个脚本，前者用于产生取数范围内的随机整数，产	生出正确结果以做对比，以及产生测试的汇编程序（每个指令n次等）；后者用于将前者产生的汇编程序转	换为机器码，并通过verilog的initial预载入程序的存储模块中。
在verilog仿真中使用$monitor指令每隔200ns输出关键信号值，可便捷地与脚本产生的正确结果做对比。
